@Author
	Залетин Никита Андреевич [nicitazaletin@yandex.ru]
	
Описание:
	Содержит реализацию для кластеризации изображений в формате png

# Документация коду


**Описание:**

- **cv2**: Модуль OpenCV для компьютерного зрения, используется для обработки изображений.
- **numpy**: Библиотека для работы с массивами и матрицами, используется для численных вычислений.
- **sklearn.cluster**: Модуль для реализации алгоритмов кластеризации, таких как Birch и AgglomerativeClustering.
- **json**: Стандартная библиотека для работы с JSON-файлами, используется для чтения конфигурации.
- **pyclustering.cluster.rock**: Модуль, реализующий алгоритм кластеризации ROCK.
- **time**: Стандартная библиотека для работы со временем, используется для измерения времени выполнения.

---

## Функции

### 1. `rock_clustering_image(X, config)`

**Описание:**

Функция выполняет кластеризацию данных `X` с помощью алгоритма ROCK.

**Сигнатура:**

```python
def rock_clustering_image(X, config) -> rock.rock:
```

**Параметры:**

- `X` (*array-like*): Данные для кластеризации. Обычно это массив признаков точек изображения.
- `config` (*dict*): Словарь с параметрами конфигурации для алгоритма ROCK.

**Конфигурационные параметры:**

- `radius` (*float*): Радиус для определения соседей. По умолчанию `1.0`.
- `n_clusters` (*int*): Количество кластеров. По умолчанию `2`.
- `threshold` (*float*): Порог сходства для объединения кластеров. По умолчанию `0.5`.

**Возвращаемое значение:**

- Объект `rock.rock`, настроенный для выполнения кластеризации.


---

### 2. `birch_clustering_image(config)`

**Описание:**

Создает объект кластеризации с использованием алгоритма Birch.

**Сигнатура:**

```python
def birch_clustering_image(config) -> Birch:
```

**Параметры:**

- `config` (*dict*): Словарь с параметрами конфигурации для алгоритма Birch.

**Конфигурационные параметры:**

- `threshold` (*float*): Пороговое значение для контроля роста CF-дерева. По умолчанию `20`.
- `n_clusters` (*int*): Количество кластеров или объект-кластеризатор. По умолчанию `2`.

**Возвращаемое значение:**

- Объект `Birch`, настроенный для выполнения кластеризации.

---

### 3. `cure_clustering_image(config)`

**Описание:**

Создает объект кластеризации с использованием алгоритма AgglomerativeClustering, имитируя алгоритм CURE.

**Сигнатура:**

```python
def cure_clustering_image(config) -> AgglomerativeClustering:
```

**Параметры:**

- `config` (*dict*): Словарь с параметрами конфигурации для алгоритма CURE.

**Конфигурационные параметры:**

- `n_clusters` (*int*): Количество кластеров. По умолчанию `2`.
- `linkage` (*str*): Метод связи для агломеративной кластеризации (`"ward"`, `"complete"`, `"average"`, `"single"`). По умолчанию `"complete"`.
- `affinity` (*str*): Мера сходства (`"euclidean"`, `"l1"`, `"l2"`, `"manhattan"`, `"cosine"`, `"precomputed"`). По умолчанию `"euclidean"`.

**Возвращаемое значение:**

- Объект `AgglomerativeClustering`, настроенный для выполнения кластеризации.


---

### 4. `clustering_image(image_path, config_path)`

**Описание:**

Главная функция для выполнения кластеризации изображения с использованием выбранного алгоритма и сохранения результирующего изображения.

**Сигнатура:**

```python
def clustering_image(image_path, config_path) -> dict:
```

**Параметры:**

- `image_path` (*str*): Путь к входному изображению.
- `config_path` (*str*): Путь к JSON-файлу с конфигурацией.

**Возвращаемое значение:**

- `dict`: Словарь с ключом `"output_path"`, содержащим путь к сохраненному изображению после кластеризации.

**Алгоритм работы:**

1. **Загрузка конфигурации:**

   ```python
   with open(config_path, "r") as f:
       config = json.load(f)
   ```

   Чтение JSON-файла конфигурации, который должен содержать параметры для выбранного алгоритма.

2. **Выбор алгоритма:**

   ```python
   algorithm = config.get("algorithm", "rock")
   ```

   Извлечение названия алгоритма из конфигурации. Поддерживаются `"rock"`, `"birch"`, и `"cure"`.

3. **Загрузка и обработка изображения:**

   ```python
   image = cv2.imread(image_path)
   hsv_image = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
   ```

   - Изображение загружается с помощью OpenCV.
   - Преобразуется в цветовое пространство HSV для более эффективной кластеризации по цвету.

4. **Подготовка данных для кластеризации:**

   ```python
   coords_and_colors = [
       (x, y, hsv_image[y, x])
       for y in range(hsv_image.shape[0])
       for x in range(hsv_image.shape[1])
   ]
   X = np.array([[round(h), round(s), round(v)] for (_, _, (h, s, v)) in coords_and_colors])
   ```

   - Создается список координат и соответствующих им HSV-значений пикселей.
   - Формируется массив признаков `X` для кластеризации, содержащий округленные значения `H`, `S`, `V`.

5. **Инициализация алгоритма кластеризации:**

   ```python
   if algorithm == "birch":
       clustering_algorithm = birch_clustering_image(config.get("birch", {}))
   elif algorithm == "cure":
       clustering_algorithm = cure_clustering_image(config.get("cure", {}))
   elif algorithm == "rock":
       clustering_algorithm = rock_clustering_image(X, config.get("rock", {}))
   else:
       raise ValueError("Неподдерживаемый алгоритм кластеризации.")
   ```

   - В зависимости от выбранного алгоритма создается соответствующий объект кластеризации.
   - Параметры алгоритма передаются из конфигурационного файла.



6. **Создание и сохранение кластеризованного изображения:**

   ```python
   colors = [
       (255, 0, 0),
       (0, 255, 0),
       (0, 0, 255),

   ]
   clustered_image = np.zeros_like(image)
   for index, (x, y, _) in enumerate(coords_and_colors):
       clustered_image[y, x] = colors[labels[index] % len(colors)]
   output_path = "clustered_{}_{}".format(algorithm, image_path.split("/")[-1])
   cv2.imwrite(output_path, clustered_image)
   ```

   - Создается список цветов для визуализации кластеров.
   - Каждому пикселю присваивается цвет в зависимости от метки кластера.
   - Результирующее изображение сохраняется с префиксом, указывающим на использованный алгоритм.

7. **Возврат результата:**

   ```python
   return {"output_path": output_path}
   ```

   - Функция возвращает словарь с путем к сохраненному изображению.

---

## Замечания

- **Расширение функциональности:**

  - Для визуализации большего количества кластеров добавьте больше цветов в список `colors`.
  - Можно использовать генерацию случайных цветов или колormap для автоматического назначения цветов кластерам.


---

- **Обработка изображений с большим количеством цветов:**

  - При кластеризации изображений с широким спектром цветов убедитесь, что параметры алгоритма настроены соответствующим образом для получения адекватных результатов.
  - Возможно, потребуется предварительная обработка изображения, такая как уменьшение цветового пространства или размытие.

- **Выбор цветового пространства:**

  - В данном скрипте используется цветовое пространство HSV, оно более эффективно для кластеризации по цвету, чем RGB.
  - При необходимости можно изменить цветовое пространство на другое, например Lab или YCrCb.

---